/*! myCanvasDrawing 12-08-2014 */
function drawGrid(a,b,c){context.beginPath(),context.save(),context.strokeStyle=a;for(var d=b+.5;d<canvas.width;d+=b)context.moveTo(d,0),context.lineTo(d,canvas.height),context.stroke();for(d=c+.5;d<canvas.height;d+=c)context.moveTo(0,d),context.lineTo(canvas.width,d),context.stroke();context.restore()}function drawHorizontalLine(a){context.beginPath(),context.moveTo(0,a+.5),context.lineTo(canvas.width,a+.5),context.stroke()}function drawVericalLine(a){context.beginPath(),context.moveTo(a+.5,0),context.lineTo(a+.5,canvas.height),context.stroke()}function drawGuidewires(a,b){context.save(),context.strokeStyle="rgba(255,0,0,1)",context.lineWidth=2,drawHorizontalLine(b),drawVericalLine(a),context.restore()}function windowToCanvas(a,b){var c=canvas.getBoundingClientRect();return{x:a-c.left*(canvas.width/c.width),y:b-c.top*(canvas.height/c.height)}}function saveDrawingSurface(){drawingSurfaceImageData=context.getImageData(0,0,canvas.width,canvas.height)}function restoreDrawingSurface(){context.putImageData(drawingSurfaceImageData,0,0)}function startDragging(a){saveDrawingSurface(),mousedown.x=a.x,mousedown.y=a.y}function startEditing(){canvas.style.cursor="pointer",drawingModule="editing"}function stopEditing(){canvas.style.cursor="crosshair",drawingModule="penning"}function drawLine(a){dash.checked===!0?drawDashLine(context,mousedown.x,mousedown.y,a.x,a.y):(context.beginPath(),context.moveTo(mousedown.x,mousedown.y),context.lineTo(a.x,a.y),context.stroke())}function drawPolygon(a){var b=Math.sqrt(Math.pow(a.x-mousedown.x,2)+Math.pow(a.y-mousedown.y,2)),c=0|sides.value,d=new Polygon(a.x,a.y,b,c,0,"red","blue",!0);d.stroke(context),dragging||polygons.push(d)}function drawPolygons(){polygons.forEach(function(a){a.stroke(context)})}function drawDashLine(a,b,c,d,e,f){f=f?f:5;var g=Math.abs(d-b),h=Math.abs(e-c),i=d-b,j=e-c,k=Math.sqrt(Math.pow(g,2)+Math.pow(h,2)),l=Math.floor(k/f);a.beginPath();for(var m=0,n=l;n>m;m++)a[m%2===0?"moveTo":"lineTo"](b+i/l*m,c+j/l*m);a.stroke()}function drawRectPath(a,b,c,d,e,f){a.beginPath(),f?(a.moveTo(b,c),a.lineTo(b+d,c),a.lineTo(b+d,c+e),a.lineTo(b,c+e)):a.rect(b,c,d,e),a.closePath()}function drawRect(){rounded.checked===!0?drawRoundedRect():drawRectPath(context,rubberbandRect.x,rubberbandRect.y,rubberbandRect.width,rubberbandRect.height,!0),context.stroke()}function roundedRectPath(a,b,c,d,e,f){a.beginPath(),a.moveTo(b+f,c),a.arcTo(b+d,c,b+d,c+e,f),a.arcTo(b+d,c+e,b,c+e,f),a.arcTo(b,c+e,b,c,f),a.arcTo(b,c,b+d,c,f),a.closePath()}function drawRoundedRect(){roundedRectPath(context,rubberbandRect.x,rubberbandRect.y,rubberbandRect.width,rubberbandRect.height,10),context.stroke()}function drawEraseShape(a){context.beginPath(),context.width=1,context.arc(a.x,a.y,10,0,2*Math.PI,!0),context.stroke()}function drawErasing(a){context.save(),context.beginPath(),context.width=1,context.arc(a.x,a.y,10,0,2*Math.PI,!0),context.clip(),context.clearRect(0,0,canvas.width,canvas.height),drawGrid("lightgray",10,10),context.restore()}function drawRubberBandShape(a){context.save(),context.strokeStyle=strokeColorSelect.value,drawFun[drawingModule](a),context.restore()}function updateRubberBand(a){updateRubberBandRect(a),drawRubberBandShape(a)}function updateRubberBandRect(a){var b=Math.abs(a.x-mousedown.x),c=Math.abs(a.y-mousedown.y),d={x:a.x-mousedown.x>0?mousedown.x:a.x,y:a.y-mousedown.y>0?mousedown.y:a.y};rubberbandRect.width=b,rubberbandRect.height=c,rubberbandRect.x=d.x,rubberbandRect.y=d.y}var canvas=document.getElementById("mydrawing"),context=canvas.getContext("2d"),clearBtn=document.getElementById("clearAll"),eraseBtn=document.getElementById("erase"),polygonBtn=document.getElementById("polygon"),penBtn=document.getElementById("pen"),lineBtn=document.getElementById("line"),rectBtn=document.getElementById("rect"),editingBtn=document.getElementById("editing"),strokeColorSelect=document.getElementById("stroke-color"),fillColorSelect=document.getElementById("fill-color"),guidewire=document.getElementById("guidewire"),dash=document.getElementById("dash"),rounded=document.getElementById("rounded"),sides=document.getElementById("sides"),drawingModule="penning",dragging=!1,polygons=[],drawingSurfaceImageData,mousedown={},rubberbandRect={},draggingOffX,draggingOffY;drawGrid("lightgray",10,10);var Polygon=function(a,b,c,d,e,f,g,h){this.x=a,this.y=b,this.radius=c,this.sides=d,this.startAngle=e,this.strokeStyle=f,this.fillStyle=g,this.filled=h};Polygon.prototype={getPoints:function(){for(var a=[],b=this.startAngle||0,c=0,d=this.sides;d>c;c++)a.push({x:this.x+this.radius*Math.sin(b),y:this.y-this.radius*Math.cos(b)}),b+=2*Math.PI/this.sides;return a},createPath:function(a){var b=this.getPoints();a.beginPath(),a.moveTo(b[0].x,b[0].y);for(var c=1,d=this.sides;d>c;c++)a.lineTo(b[c].x,b[c].y);a.closePath()},stroke:function(a){a.save(),this.createPath(a),a.strokeStyle=this.strokeStyle,a.stroke(),a.restore()},fill:function(){context.save(),this.createPath(),context.strokeStyle=this.strokeStyle,context.fill(),context.restore()},move:function(a,b){this.x=a,this.y=b}},canvas.onmousedown=function(a){var b=windowToCanvas(a.clientX,a.clientY);a.preventDefault(),moduleMouseDown[drawingModule](b)},canvas.onmousemove=function(a){var b=windowToCanvas(a.clientX,a.clientY);a.preventDefault(),moduleMouseMove[drawingModule](b)},canvas.onmouseup=function(a){var b=windowToCanvas(a.clientX,a.clientY);dragging=!1,moduleMouseUp[drawingModule](b)},clearBtn.onclick=function(){context.clearRect(0,0,canvas.width,canvas.height),drawGrid("lightgray",10,10)},penBtn.onclick=function(){drawingModule="penning"},editingBtn.onclick=function(){startEditing()},lineBtn.onclick=function(){drawingModule="lining"},rectBtn.onclick=function(){drawingModule="rectting"},eraseBtn.onclick=function(){drawingModule="erasing",saveDrawingSurface()},polygonBtn.onclick=function(){drawingModule="polygonning"};var drawFun={lining:drawLine,rectting:drawRect,polygonning:drawPolygon},moduleMouseDown={penning:function(){dragging=!0},lining:function(a){startDragging(a),dragging=!0},rectting:function(a){startDragging(a),dragging=!0},polygonning:function(a){startDragging(a),dragging=!0},editing:function(a){polygons.forEach(function(b){return b.createPath(context),context.isPointInPath(a.x,a.y)?(startDragging(a),dragging=b,draggingOffX=a.x-b.x,void(draggingOffY=a.y-b.y)):void 0})},erasing:function(){restoreDrawingSurface(),dragging=!0}},moduleMouseMove={penning:function(a){dragging&&(context.beginPath(),context.arc(a.x,a.y,1,0,2*Math.PI,!0),context.stroke())},lining:function(a){dragging&&(restoreDrawingSurface(),updateRubberBand(a),guidewire.checked&&drawGuidewires(a.x,a.y))},rectting:function(a){dragging&&(restoreDrawingSurface(),updateRubberBand(a),guidewire.checked&&drawGuidewires(a.x,a.y))},polygonning:function(a){dragging&&(restoreDrawingSurface(),updateRubberBand(a),guidewire.checked&&drawGuidewires(a.x,a.y))},editing:function(a){dragging&&(dragging.x=a.x-draggingOffX,dragging.y=a.y-draggingOffY,context.clearRect(0,0,canvas.width,canvas.height),drawGrid("lightgray",10,10),drawPolygons())},erasing:function(a){dragging?(restoreDrawingSurface(),drawErasing(a),saveDrawingSurface(),drawEraseShape(a)):(restoreDrawingSurface(),drawErasing(a),drawEraseShape(a))}},moduleMouseUp={penning:function(){dragging=!1},lining:function(a){restoreDrawingSurface(),updateRubberBand(a)},rectting:function(a){restoreDrawingSurface(),updateRubberBand(a)},polygonning:function(a){restoreDrawingSurface(),updateRubberBand(a)},editing:function(){},erasing:function(){restoreDrawingSurface()}};